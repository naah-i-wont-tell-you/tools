<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Document Signing Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background: #ffffff;
            border-bottom: 1px solid #e8e8e8;
        }

        nav .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        nav .logo i {
            margin-right: 8px;
            font-size: 18px;
            color: #333;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 32px;
        }

        nav ul li a {
            text-decoration: none;
            color: #666;
            font-weight: 400;
            font-size: 15px;
            transition: color 0.2s ease;
        }

        nav ul li a:hover {
            color: #333;
        }

        /* Screen Management */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 60px 40px 40px;
            background: #ffffff;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 42px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .hero p {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .hero .features {
            display: flex;
            justify-content: center;
            gap: 40px;
            color: #666;
            font-size: 14px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-item i {
            font-size: 14px;
            color: #666;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 40px;
        }

        .main-section {
            background: #ffffff;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 30px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 40px;
        }

        .upload-area:hover {
            border-color: #2c3e50;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #2c3e50;
            background: #f0f8ff;
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .upload-icon i {
            font-size: 24px;
            color: #999;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #999;
        }

        /* Buttons */
        .continue-button {
            width: 100%;
            background: #2c3e50;
            color: #ffffff;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .continue-button:hover:not(:disabled) {
            background: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.2);
        }

        .continue-button:disabled {
            background: #bbb;
            cursor: not-allowed;
        }

        .back-link {
            display: flex;
            align-items: center;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #333;
        }

        .back-link i {
            margin-right: 8px;
        }

        /* Setup Screen */
        .setup-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 40px;
        }

        .setup-section {
            background: #ffffff;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #2c3e50;
        }

        /* Signature Type Cards */
        .signature-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .signature-type {
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .signature-type:hover {
            border-color: #2c3e50;
        }

        .signature-type.selected {
            border-color: #2c3e50;
            background: #f8f9fa;
        }

        .signature-type i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #666;
        }

        .signature-type.selected i {
            color: #2c3e50;
        }

        .type-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .type-description {
            font-size: 12px;
            color: #666;
        }

        /* Style Selection */
        .signature-styles {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .signature-style {
            padding: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            font-size: 16px;
        }

        .signature-style:hover {
            border-color: #2c3e50;
        }

        .signature-style.selected {
            border-color: #2c3e50;
            background: #f8f9fa;
        }

        .signature-style.font1 { font-family: 'Brush Script MT', cursive; }
        .signature-style.font2 { font-family: 'Dancing Script', cursive; }
        .signature-style.font3 { font-family: 'Times New Roman', serif; font-style: italic; }
        .signature-style.font4 { font-family: 'Courier New', monospace; font-weight: bold; }

        /* Color Selection */
        .color-picker {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 20px 0;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #2c3e50;
            transform: scale(1.1);
        }

        /* Drawing Canvas */
        .drawing-section {
            background: #f8f9fa;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .drawing-section.active {
            display: block;
        }

        #drawingCanvas {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: crosshair;
            display: block;
            margin: 0 auto 15px;
        }

        .canvas-controls {
            text-align: center;
            gap: 10px;
            display: flex;
            justify-content: center;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Digital Setup */
        .digital-section {
            background: #f8f9fa;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .digital-section.active {
            display: block;
        }

        .upload-signature-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        .upload-signature-area:hover {
            border-color: #2c3e50;
            background: #f8f9fa;
        }

        .signature-preview {
            margin-top: 15px;
            text-align: center;
        }

        .signature-preview img {
            max-width: 200px;
            max-height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            padding: 10px;
        }

        /* Signing Interface */
        .signing-interface {
            background: #ffffff;
            min-height: 100vh;
        }

        .signing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            border-bottom: 1px solid #e8e8e8;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: #666;
        }

        .signing-content {
            display: flex;
            height: calc(100vh - 140px);
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e8e8e8;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .tool-button {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid #e8e8e8;
            background: #ffffff;
            color: #333;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-button:hover {
            border-color: #2c3e50;
            background: #f8f9fa;
        }

        .download-btn {
            width: 100%;
            background: #28a745;
            color: #ffffff;
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .download-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* PDF Viewer */
        .pdf-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
        }

        .viewer-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #ffffff;
            border-bottom: 1px solid #e8e8e8;
        }

        .page-navigation {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-nav-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .page-nav-btn:hover:not(:disabled) {
            border-color: #2c3e50;
            color: #2c3e50;
        }

        .page-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: #666;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            border-color: #2c3e50;
            color: #2c3e50;
        }

        .zoom-level {
            font-size: 14px;
            color: #666;
            min-width: 40px;
            text-align: center;
        }

        .pdf-canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
            position: relative;
        }

        .pdf-page-container {
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        #pdfCanvas {
            display: block;
            cursor: crosshair;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #666;
        }

        .signature-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed #2c3e50;
            background: rgba(44, 62, 80, 0.1);
            padding: 5px;
            border-radius: 4px;
            z-index: 10;
        }

        .signature-overlay:hover {
            border-color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }

        .signature-overlay .remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Status Messages */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .signing-content {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
            }

            nav {
                padding: 16px 20px;
            }

            nav ul {
                display: none;
            }

            .main-content, .setup-content {
                padding: 20px;
            }

            .main-section, .setup-section {
                padding: 20px;
            }

            .hero {
                padding: 40px 20px 20px;
            }

            .hero h1 {
                font-size: 32px;
            }

            .hero .features {
                flex-direction: column;
                gap: 16px;
            }

            .signature-types {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Upload Screen -->
    <div class="screen active" id="uploadScreen">
        <nav>
            <a href="#" class="logo">
                <i class="fa-solid fa-signature"></i>
                XTPdf
            </a>
            <ul>
                <li><a href="#tools">Tools</a></li>
                <li><a href="#features">Features</a></li>
                <li><a href="#about">About</a></li>
            </ul>
        </nav>

        <section class="hero">
            <h1>Sign PDF Documents</h1>
            <p>Add professional signatures to your PDF documents securely</p>
            <div class="features">
                <div class="feature-item">
                    <i class="fa-solid fa-shield-halved"></i>
                    <span>100% Client-Side Processing</span>
                </div>
                <div class="feature-item">
                    <i class="fa-solid fa-cloud-slash"></i>
                    <span>No Server Upload</span>
                </div>
                <div class="feature-item">
                    <i class="fa-solid fa-lock"></i>
                    <span>Digital Certificates</span>
                </div>
            </div>
        </section>

        <div class="main-content">
            <div class="main-section">
                <h2 class="section-title">Upload PDF Document</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                    </div>
                    <div class="upload-text">Drop your PDF here or click to browse</div>
                    <div class="upload-subtext">Maximum file size: 50MB</div>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                </div>

                <button class="continue-button" id="continueToSetup" disabled>
                    <i class="fa-solid fa-play"></i>
                    Continue to Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div class="screen" id="setupScreen">
        <nav>
            <a href="#" class="logo">
                <i class="fa-solid fa-signature"></i>
                PDFSign
            </a>
            <ul>
                <li><a href="#tools">Tools</a></li>
                <li><a href="#features">Features</a></li>
                <li><a href="#about">About</a></li>
            </ul>
        </nav>

        <div class="setup-content">
            <div class="setup-section">
                <a href="#" class="back-link" id="backToUpload">
                    <i class="fa-solid fa-arrow-left"></i>
                    Back to Upload
                </a>
                
                <h2 class="section-title">Signature Setup</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="fullName" placeholder="Enter your full name" required>
                        </div>
                        <div>
                            <label class="form-label">Email (Optional)</label>
                            <input type="email" class="form-input" id="email" placeholder="your@email.com">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Signature Type</label>
                    <div class="signature-types">
                        <div class="signature-type selected" id="simpleType">
                            <i class="fa-solid fa-pen"></i>
                            <div class="type-title">Simple</div>
                            <div class="type-description">Text-based signature</div>
                        </div>
                        <div class="signature-type" id="drawType">
                            <i class="fa-solid fa-pencil"></i>
                            <div class="type-title">Draw</div>
                            <div class="type-description">Hand-drawn signature</div>
                        </div>
                        <div class="signature-type" id="digitalType">
                            <i class="fa-solid fa-certificate"></i>
                            <div class="type-title">Image</div>
                            <div class="type-description">Upload signature image</div>
                        </div>
                    </div>
                </div>

                <!-- Drawing Section -->
                <div class="drawing-section" id="drawingSection">
                    <h4 style="margin-bottom: 15px; color: #333;">Draw Your Signature</h4>
                    <canvas id="drawingCanvas" width="400" height="120"></canvas>
                    <div class="canvas-controls">
                        <button class="btn-secondary" id="clearCanvas">Clear</button>
                        <button class="btn-secondary" id="saveDrawing">Save</button>
                    </div>
                </div>

                <!-- Digital Section - Image Upload -->
                <div class="digital-section" id="digitalSection">
                    <h4 style="margin-bottom: 15px; color: #333;">Upload Signature Image</h4>
                    <div class="upload-signature-area" id="uploadSignatureArea">
                        <div class="upload-icon">
                            <i class="fa-solid fa-image"></i>
                        </div>
                        <div class="upload-text">Drop signature image here or click to browse</div>
                        <div class="upload-subtext">PNG, JPG, or GIF files (max 5MB)</div>
                        <input type="file" id="signatureImageInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="signature-preview" id="signaturePreview" style="display: none;">
                        <img id="previewImage" alt="Signature preview">
                        <div style="margin-top: 10px;">
                            <button class="btn-secondary" id="removeImage">Remove Image</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Signature Style</label>
                    <div class="signature-styles" id="signatureStyles">
                        <div class="signature-style font1 selected" data-font="font1">Signature</div>
                        <div class="signature-style font2" data-font="font2">Signature</div>
                        <div class="signature-style font3" data-font="font3">Signature</div>
                        <div class="signature-style font4" data-font="font4">Signature</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Signature Color</label>
                    <div class="color-picker">
                        <div class="color-option selected" data-color="#000" style="background: #000;"></div>
                        <div class="color-option" data-color="#dc3545" style="background: #dc3545;"></div>
                        <div class="color-option" data-color="#007bff" style="background: #007bff;"></div>
                        <div class="color-option" data-color="#28a745" style="background: #28a745;"></div>
                    </div>
                </div>

                <button class="continue-button" id="proceedToSigning">
                    <i class="fa-solid fa-arrow-right"></i>
                    Continue to Signing
                </button>
            </div>
        </div>
    </div>

    <!-- Signing Screen -->
    <div class="screen" id="signingScreen">
        <div class="signing-interface">
            <nav>
                <a href="#" class="logo">
                    <i class="fa-solid fa-signature"></i>
                    PDFSign
                </a>
                <ul>
                    <li><a href="#tools">Tools</a></li>
                    <li><a href="#features">Features</a></li>
                    <li><a href="#about">About</a></li>
                </ul>
            </nav>

            <div class="signing-header">
                <div>
                    <a href="#" class="back-link" id="backToSetup">
                        <i class="fa-solid fa-arrow-left"></i>
                        Back to Setup
                    </a>
                    <div class="page-title">Sign Document</div>
                    <div class="page-subtitle">Click anywhere on the document to place your signature</div>
                </div>
            </div>

            <div class="signing-content">
                <div class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">Signature Tools</div>
                        <button class="tool-button" id="addSignature">
                            <i class="fa-solid fa-plus"></i>
                            Add Signature
                        </button>
                        <button class="tool-button" id="clearAll">
                            <i class="fa-solid fa-trash"></i>
                            Clear All
                        </button>
                    </div>

                    <div class="sidebar-section" style="margin-top: auto; border-top: 1px solid #e8e8e8; padding-top: 20px;">
                        <button class="download-btn" id="downloadPDF">
                            <i class="fa-solid fa-download"></i>
                            Download Signed PDF
                        </button>
                    </div>
                </div>

                <div class="pdf-viewer">
                    <div class="viewer-toolbar">
                        <div class="page-navigation">
                            <button class="page-nav-btn" id="prevPage" disabled>
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <span class="page-info" id="pageInfo">Page 1 of 1</span>
                            <button class="page-nav-btn" id="nextPage" disabled>
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoomOut">
                                <i class="fa-solid fa-search-minus"></i>
                            </button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                            <button class="zoom-btn" id="zoomIn">
                                <i class="fa-solid fa-search-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="pdf-canvas-container" id="pdfCanvasContainer">
                        <div class="loading-message" id="loadingIndicator">Loading PDF...</div>
                        <div class="pdf-page-container" id="pdfPageContainer" style="display: none;">
                            <canvas id="pdfCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set PDF.js worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        class PDFSignerApp {
            constructor() {
                this.currentScreen = 'uploadScreen';
                this.pdfFile = null;
                this.pdfDoc = null;
                this.currentPage = 1;
                this.totalPages = 0;
                this.zoomLevel = 1.0;
                this.signatures = [];
                this.signatureConfig = {
                    type: 'simple',
                    font: 'font1',
                    color: '#000',
                    name: '',
                    email: '',
                    drawnSignature: null,
                    imageSignature: null
                };
                
                this.setupEventListeners();
                this.setupDragAndDrop();
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('continueToSetup')?.addEventListener('click', () => this.showScreen('setupScreen'));
                document.getElementById('backToUpload')?.addEventListener('click', () => this.showScreen('uploadScreen'));
                document.getElementById('backToSetup')?.addEventListener('click', () => this.showScreen('setupScreen'));
                document.getElementById('proceedToSigning')?.addEventListener('click', () => this.proceedToSigning());

                // File upload
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea?.addEventListener('click', () => fileInput?.click());
                fileInput?.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        this.handleFileSelection(e.target.files[0]);
                    }
                });

                // Signature type selection
                document.querySelectorAll('.signature-type').forEach(type => {
                    type.addEventListener('click', () => this.selectSignatureType(type.id));
                });

                // Style selection
                document.querySelectorAll('.signature-style').forEach(style => {
                    style.addEventListener('click', () => this.selectStyle(style));
                });

                // Color selection
                document.querySelectorAll('.color-option').forEach(color => {
                    color.addEventListener('click', () => this.selectColor(color));
                });

                // Form inputs
                document.getElementById('fullName')?.addEventListener('input', (e) => {
                    this.signatureConfig.name = e.target.value;
                });

                document.getElementById('email')?.addEventListener('input', (e) => {
                    this.signatureConfig.email = e.target.value;
                });

                // Drawing canvas
                this.setupDrawingCanvas();
                this.setupImageUpload();

                // PDF viewer controls
                document.getElementById('prevPage')?.addEventListener('click', () => this.previousPage());
                document.getElementById('nextPage')?.addEventListener('click', () => this.nextPage());
                document.getElementById('zoomIn')?.addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut')?.addEventListener('click', () => this.zoomOut());

                // Signing tools
                document.getElementById('addSignature')?.addEventListener('click', () => this.toggleSignatureMode());
                document.getElementById('clearAll')?.addEventListener('click', () => this.clearAllSignatures());
                document.getElementById('downloadPDF')?.addEventListener('click', () => this.downloadSignedPDF());
            }

            setupDragAndDrop() {
                const uploadArea = document.getElementById('uploadArea');
                if (!uploadArea) return;

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
                });

                uploadArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files && files[0]) {
                        this.handleFileSelection(files[0]);
                    }
                }, false);
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId)?.classList.add('active');
                this.currentScreen = screenId;
            }

            async handleFileSelection(file) {
                const uploadArea = document.getElementById('uploadArea');
                const continueBtn = document.getElementById('continueToSetup');
                
                if (file.type !== 'application/pdf') {
                    this.showStatus('Please select a valid PDF file.', 'error');
                    return;
                }

                if (file.size > 50 * 1024 * 1024) {
                    this.showStatus('File size exceeds 50MB limit.', 'error');
                    return;
                }

                this.pdfFile = file;
                
                uploadArea.innerHTML = `
                    <div class="upload-icon">
                        <i class="fa-solid fa-file-pdf" style="color: #28a745;"></i>
                    </div>
                    <div class="upload-text" style="color: #28a745; font-weight: 500;">${file.name}</div>
                    <div class="upload-subtext">
                        Size: ${(file.size / 1024 / 1024).toFixed(2)} MB - Ready to process
                    </div>
                `;
                continueBtn.disabled = false;
                this.showStatus('PDF file selected successfully!', 'success');
            }

            selectSignatureType(typeId) {
                document.querySelectorAll('.signature-type').forEach(type => {
                    type.classList.remove('selected');
                });
                document.getElementById(typeId)?.classList.add('selected');

                const drawingSection = document.getElementById('drawingSection');
                const digitalSection = document.getElementById('digitalSection');
                
                drawingSection?.classList.toggle('active', typeId === 'drawType');
                digitalSection?.classList.toggle('active', typeId === 'digitalType');

                this.signatureConfig.type = typeId.replace('Type', '');
            }

            selectStyle(styleElement) {
                document.querySelectorAll('.signature-style').forEach(style => {
                    style.classList.remove('selected');
                });
                styleElement.classList.add('selected');
                this.signatureConfig.font = styleElement.dataset.font;
            }

            selectColor(colorElement) {
                document.querySelectorAll('.color-option').forEach(color => {
                    color.classList.remove('selected');
                });
                colorElement.classList.add('selected');
                this.signatureConfig.color = colorElement.dataset.color;
            }

            setupDrawingCanvas() {
                const canvas = document.getElementById('drawingCanvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                let paths = [];
                let currentPath = [];

                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';

                const startDrawing = (e) => {
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    currentPath = [{x, y}];
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                };

                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    currentPath.push({x, y});
                    ctx.lineTo(x, y);
                    ctx.stroke();
                };

                const stopDrawing = () => {
                    if (!isDrawing) return;
                    isDrawing = false;
                    if (currentPath.length > 0) {
                        paths.push([...currentPath]);
                    }
                };

                // Mouse events
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                // Touch events
                canvas.addEventListener('touchstart', startDrawing);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stopDrawing);

                document.getElementById('clearCanvas')?.addEventListener('click', () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    paths = [];
                    this.signatureConfig.drawnSignature = null;
                    this.showStatus('Canvas cleared.', 'success');
                });

                document.getElementById('saveDrawing')?.addEventListener('click', () => {
                    if (paths.length === 0) {
                        this.showStatus('Please draw your signature first.', 'error');
                        return;
                    }
                    this.signatureConfig.drawnSignature = canvas.toDataURL();
                    this.showStatus('Signature drawing saved!', 'success');
                });
            }

            setupImageUpload() {
                const uploadArea = document.getElementById('uploadSignatureArea');
                const fileInput = document.getElementById('signatureImageInput');
                const preview = document.getElementById('signaturePreview');
                const previewImage = document.getElementById('previewImage');

                uploadArea?.addEventListener('click', () => fileInput?.click());

                fileInput?.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        this.handleSignatureImage(e.target.files[0]);
                    }
                });

                document.getElementById('removeImage')?.addEventListener('click', () => {
                    preview.style.display = 'none';
                    this.signatureConfig.imageSignature = null;
                    fileInput.value = '';
                    this.showStatus('Signature image removed.', 'success');
                });
            }

            handleSignatureImage(file) {
                if (!file.type.startsWith('image/')) {
                    this.showStatus('Please select a valid image file.', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    this.showStatus('Image size exceeds 5MB limit.', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImage = document.getElementById('previewImage');
                    const preview = document.getElementById('signaturePreview');
                    
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                    this.signatureConfig.imageSignature = e.target.result;
                    this.showStatus('Signature image uploaded successfully!', 'success');
                };
                reader.readAsDataURL(file);
            }

            async proceedToSigning() {
                if (!this.signatureConfig.name.trim()) {
                    this.showStatus('Please enter your full name.', 'error');
                    return;
                }

                if (this.signatureConfig.type === 'draw' && !this.signatureConfig.drawnSignature) {
                    this.showStatus('Please draw your signature or choose a different type.', 'error');
                    return;
                }

                if (this.signatureConfig.type === 'digital' && !this.signatureConfig.imageSignature) {
                    this.showStatus('Please upload a signature image or choose a different type.', 'error');
                    return;
                }

                this.showScreen('signingScreen');
                await this.loadPDF();
            }

            async loadPDF() {
                if (!this.pdfFile) return;

                this.showStatus('Loading PDF...', 'loading');
                
                try {
                    const arrayBuffer = await this.pdfFile.arrayBuffer();
                    this.pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                    this.totalPages = this.pdfDoc.numPages;
                    this.currentPage = 1;
                    
                    await this.renderPage();
                    this.updatePageNavigation();
                    
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('pdfPageContainer').style.display = 'block';
                    
                    this.setupPDFCanvasEvents();
                    this.showStatus('PDF loaded successfully! Click to add signatures.', 'success');
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    this.showStatus('Error loading PDF. Please try again.', 'error');
                }
            }

            async renderPage() {
                if (!this.pdfDoc) return;

                const page = await this.pdfDoc.getPage(this.currentPage);
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');

                const viewport = page.getViewport({ scale: this.zoomLevel });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                this.renderSignatures();
            }

            renderSignatures() {
                // Clear existing signature overlays
                document.querySelectorAll('.signature-overlay').forEach(sig => sig.remove());

                // Render signatures for current page
                this.signatures
                    .filter(sig => sig.page === this.currentPage)
                    .forEach(sig => this.createSignatureOverlay(sig));
            }

            createSignatureOverlay(signature) {
                const container = document.getElementById('pdfPageContainer');
                const overlay = document.createElement('div');
                overlay.className = 'signature-overlay';
                overlay.style.left = signature.x + 'px';
                overlay.style.top = signature.y + 'px';

                // Create signature content based on type
                let content = '';
                if (signature.type === 'simple') {
                    content = `<span style="font-family: ${this.getFontFamily(signature.font)}; color: ${signature.color}; font-size: 18px;">${signature.name}</span>`;
                } else if (signature.type === 'draw' && signature.drawnSignature) {
                    content = `<img src="${signature.drawnSignature}" style="max-width: 150px; max-height: 50px;">`;
                } else if (signature.type === 'digital' && signature.imageSignature) {
                    content = `<img src="${signature.imageSignature}" style="max-width: 150px; max-height: 50px;">`;
                }

                overlay.innerHTML = content + `<button class="remove-btn" onclick="pdfSigner.removeSignature(${signature.id})">×</button>`;
                
                this.makeDraggable(overlay, signature);
                container.appendChild(overlay);
            }

            makeDraggable(element, signature) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

                element.onmousedown = dragMouseDown;

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    const newTop = element.offsetTop - pos2;
                    const newLeft = element.offsetLeft - pos1;
                    element.style.top = newTop + "px";
                    element.style.left = newLeft + "px";
                    
                    // Update signature position
                    signature.x = newLeft;
                    signature.y = newTop;
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }

            getFontFamily(font) {
                const fonts = {
                    font1: '"Brush Script MT", cursive',
                    font2: '"Dancing Script", cursive',
                    font3: '"Times New Roman", serif',
                    font4: '"Courier New", monospace'
                };
                return fonts[font] || fonts.font1;
            }

            setupPDFCanvasEvents() {
                const canvas = document.getElementById('pdfCanvas');
                let signatureMode = false;

                document.getElementById('addSignature').addEventListener('click', () => {
                    signatureMode = !signatureMode;
                    canvas.style.cursor = signatureMode ? 'crosshair' : 'default';
                    const btn = document.getElementById('addSignature');
                    if (signatureMode) {
                        btn.style.background = '#007bff';
                        btn.style.color = 'white';
                        this.showStatus('Click on the PDF to place your signature', 'loading');
                    } else {
                        btn.style.background = '#ffffff';
                        btn.style.color = '#333';
                    }
                });

                canvas.addEventListener('click', (e) => {
                    if (!signatureMode) return;

                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const signature = {
                        id: Date.now(),
                        page: this.currentPage,
                        x: x,
                        y: y,
                        type: this.signatureConfig.type,
                        font: this.signatureConfig.font,
                        color: this.signatureConfig.color,
                        name: this.signatureConfig.name,
                        email: this.signatureConfig.email,
                        drawnSignature: this.signatureConfig.drawnSignature,
                        imageSignature: this.signatureConfig.imageSignature
                    };

                    this.signatures.push(signature);
                    this.createSignatureOverlay(signature);
                    this.showStatus('Signature added successfully!', 'success');
                });
            }

            removeSignature(id) {
                this.signatures = this.signatures.filter(sig => sig.id !== id);
                this.renderSignatures();
                this.showStatus('Signature removed.', 'success');
            }

            clearAllSignatures() {
                this.signatures = [];
                this.renderSignatures();
                this.showStatus('All signatures cleared.', 'success');
            }

            toggleSignatureMode() {
                // This is handled in setupPDFCanvasEvents
            }

            async previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    await this.renderPage();
                    this.updatePageNavigation();
                }
            }

            async nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                    await this.renderPage();
                    this.updatePageNavigation();
                }
            }

            async zoomIn() {
                this.zoomLevel = Math.min(this.zoomLevel + 0.25, 3.0);
                await this.renderPage();
                this.updateZoomLevel();
            }

            async zoomOut() {
                this.zoomLevel = Math.max(this.zoomLevel - 0.25, 0.5);
                await this.renderPage();
                this.updateZoomLevel();
            }

            updatePageNavigation() {
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');

                if (pageInfo) pageInfo.textContent = `Page ${this.currentPage} of ${this.totalPages}`;
                if (prevBtn) prevBtn.disabled = this.currentPage <= 1;
                if (nextBtn) nextBtn.disabled = this.currentPage >= this.totalPages;
            }

            updateZoomLevel() {
                const zoomLevel = document.getElementById('zoomLevel');
                if (zoomLevel) zoomLevel.textContent = Math.round(this.zoomLevel * 100) + '%';
            }

            async downloadSignedPDF() {
                if (this.signatures.length === 0) {
                    this.showStatus('Please add at least one signature before downloading.', 'error');
                    return;
                }

                this.showStatus('Generating signed PDF...', 'loading');

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();

                    // Get original PDF data
                    const arrayBuffer = await this.pdfFile.arrayBuffer();
                    const originalDoc = await pdfjsLib.getDocument(arrayBuffer).promise;

                    // Process each page
                    for (let pageNum = 1; pageNum <= this.totalPages; pageNum++) {
                        if (pageNum > 1) pdf.addPage();

                        const page = await originalDoc.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 1.0 });

                        // Create canvas for the page
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;

                        await page.render({
                            canvasContext: ctx,
                            viewport: viewport
                        }).promise;

                        // Add page as image
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                        // Add signatures for this page
                        const pageSignatures = this.signatures.filter(sig => sig.page === pageNum);
                        for (const sig of pageSignatures) {
                            const x = (sig.x * pdfWidth) / canvas.width;
                            const y = (sig.y * pdfHeight) / canvas.height;

                            if (sig.type === 'simple') {
                                pdf.setTextColor(sig.color);
                                pdf.setFontSize(12);
                                pdf.text(sig.name, x, y);
                            } else if (sig.type === 'draw' && sig.drawnSignature) {
                                pdf.addImage(sig.drawnSignature, 'PNG', x, y, 40, 15);
                            } else if (sig.type === 'digital' && sig.imageSignature) {
                                pdf.addImage(sig.imageSignature, 'PNG', x, y, 40, 15);
                            }
                        }
                    }

                    // Download the PDF
                    const fileName = this.pdfFile.name.replace('.pdf', '_signed.pdf');
                    pdf.save(fileName);
                    this.showStatus('Signed PDF downloaded successfully!', 'success');

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    this.showStatus('Error generating signed PDF. Please try again.', 'error');
                }
            }

            showStatus(message, type = 'success') {
                // Remove existing status messages
                document.querySelectorAll('.status-message').forEach(msg => msg.remove());

                const statusDiv = document.createElement('div');
                statusDiv.className = `status-message ${type}`;
                statusDiv.textContent = message;
                document.body.appendChild(statusDiv);

                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, type === 'loading' ? 5000 : 3000);
            }
        }

        // Initialize app when DOM is loaded
        let pdfSigner;
        document.addEventListener('DOMContentLoaded', () => {
            pdfSigner = new PDFSignerApp();
        });
    </script>
</body>
</html>